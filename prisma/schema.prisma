datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserLevel {
  NOVICE
  EXPERIENCED
  EXPERT
}

model User {
  id               Int        @id @default(autoincrement())
  name             String?
  email            String     @unique
  password         String
  role             String
  points           Int?
  phoneNumber      String?
  city             String?
  country          String?
  registrationDate DateTime   @default(now())
  isCompanyVerified Boolean   @default(false)
  level            UserLevel  @default(NOVICE)
  company          Company?   // Связь с моделью Company, без аргументов fields и references
  companyId        Int?
  listings         Listing[]
  responses        Response[]
  pointsSpent      PointsSpent[]
  pointsAdded      PointsAdded[]
  employees        CompanyEmployee[] // Связь с компанией через сотрудников
}

model Company {
  id              Int        @id @default(autoincrement())
  name            String
  binOrIin        String
  region          String
  contacts        String?
  director        String
  rating          Float?
  owner           User       @relation(fields: [ownerId], references: [id])
  ownerId         Int        @unique // Уникальный владелец компании
  employees       CompanyEmployee[] // Связь с сотрудниками компании
}

model CompanyEmployee {
  id          Int       @id @default(autoincrement())
  user        User      @relation(fields: [userId], references: [id])
  userId      Int
  company     Company   @relation(fields: [companyId], references: [id])
  companyId   Int
  role        String    // Роль сотрудника (например, "менеджер", "ассистент")
  joinedAt    DateTime  @default(now()) // Дата присоединения к компании
}

model PointsAdded {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     Int
  points     Int      // Количество добавленных баллов
  addedAt    DateTime @default(now()) // Дата и время пополнения
  addedBy    String?  // Идентификатор администратора, который добавил баллы
  reason     String?  // Причина пополнения
  priceAtAdded Int?   // Стоимость балла на момент пополнения
}

model PointsSpent {
  id          Int      @id @default(autoincrement())
  user        User     @relation(fields: [userId], references: [id])
  userId      Int
  response    Response @relation(fields: [responseId], references: [id])
  responseId  Int
  listing     Listing  @relation(fields: [listingId], references: [id])
  listingId   Int
  pointsUsed  Int      // Количество потраченных баллов
  spentAt     DateTime @default(now()) // Дата и время расхода баллов
}

model PointsPrice {
  id         Int      @id @default(autoincrement())
  price      Int      // Стоимость одного балла
  validFrom  DateTime @default(now())
  validUntil DateTime?
  history    PointPriceHistory[] @relation("PriceHistory")
}

model PointPriceHistory {
  id           Int      @id @default(autoincrement())
  pointsPrice  PointsPrice @relation("PriceHistory", fields: [pointsPriceId], references: [id])
  pointsPriceId Int
  oldPrice     Int      // Старая цена балла
  newPrice     Int      // Новая цена балла
  changedAt    DateTime @default(now())
  changedBy    String   // Кто изменил цену
}

model PointsStatistics {
  id               Int      @id @default(autoincrement())
  period           String   // Период статистики
  totalPointsAdded Int      // Общая сумма начисленных баллов за период
  totalPointsSpent Int      // Общая сумма потраченных баллов за период
  statisticsDate   DateTime @default(now())
}

model Listing {
  id             Int       @id @default(autoincrement())
  title          String
  content        String
  published      Boolean   @default(false)
  deliveryDate   DateTime  @default(now())
  publishedAt    DateTime  @default(now())
  expirationDate DateTime?
  purchaseDate   DateTime?
  author         User      @relation(fields: [authorId], references: [id])
  authorId       Int
  responses      Response[] 
  category       Category? @relation(fields: [categoryId], references: [id])
  categoryId     Int
  responseCost   Int       @default(10)
  pointsSpent    PointsSpent[]
  purchaseMethod   String?   // Метод закупки, например, "понижение цены", "запрос ценового предложения"
  paymentTerms     String?   // Условия оплаты (новое поле)
  type          String   // Новый тип объявления: товар или услуга
}

model Response {
  id          Int      @id @default(autoincrement())
  responder   User     @relation(fields: [responderId], references: [id])
  responderId Int
  message     String?
  listing     Listing  @relation(fields: [listingId], references: [id])
  listingId   Int
  status      String   @default("pending")
  createdAt   DateTime @default(now())
  accepted    Boolean?
  pointsSpent PointsSpent[]
}

model Category {
  id       Int       @id @default(autoincrement())
  name     String    @unique
  listings Listing[]
}
